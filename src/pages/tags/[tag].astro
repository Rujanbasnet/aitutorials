---
import BaseLayout from '@layouts/BaseLayout.astro';
import PostCard from '@components/content/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allCollections = await Promise.all([
    getCollection('tutorials'),
    getCollection('news'),
    getCollection('blog'),
    getCollection('resources'),
  ]);

  const tagMap = new Map<string, any[]>();
  const collectionNames = ['tutorials', 'news', 'blog', 'resources'];

  allCollections.forEach((collection, i) => {
    collection.forEach((entry) => {
      if (entry.data.draft) return;
      entry.data.tags.forEach((tag: string) => {
        if (!tagMap.has(tag)) tagMap.set(tag, []);
        tagMap.get(tag)!.push({ ...entry, _collection: collectionNames[i] });
      });
    });
  });

  return [...tagMap.entries()].map(([tag, entries]) => ({
    params: { tag },
    props: {
      tag,
      entries: entries.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag, entries } = Astro.props;
---

<BaseLayout title={`#${tag}`} description={`All content tagged with "${tag}".`}>
  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
    <div class="mb-10">
      <p class="label mb-3">Tag</p>
      <h1 class="text-title mb-3">
        <span class="text-[var(--color-accent)]">#{tag}</span>
      </h1>
      <p class="text-lg text-[var(--color-text-secondary)]">
        {entries.length} {entries.length === 1 ? 'article' : 'articles'} tagged with "{tag}"
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 stagger">
      {entries.map((entry: any) => (
        <div class="fade-in">
          <PostCard
            title={entry.data.title}
            description={entry.data.description}
            href={`/${entry._collection}/${entry.id}/`}
            pubDate={entry.data.pubDate}
            tags={entry.data.tags}
            difficulty={entry.data.difficulty}
            body={entry.body || ''}
          />
        </div>
      ))}
    </div>
  </section>
</BaseLayout>
